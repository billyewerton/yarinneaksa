<%- include('../layouts/main_header.ejs'); %>

<style>
   .containera {
			display: flex;
			flex-direction: row-reverse;
			align-items: center;
			position: fixed;
			top: 20px;
			right: 20px;
			background-color: green;
			border-radius: 50%;
			padding: 1px;
			z-index: 999;
			width: 150px;
			height: 150px;
		}
		.containera h2, .containera h3 {
			color: white;
			margin: 0;
			text-align: center;
		}
		.containera h3::before {
			/*content: "R$";*/
		}
</style>


<div class="containera">
  <div>
    <h2>Preço Sugerido</h2>
    <h3 id="total_geral">0,00</h3>
  </div>
</div>
<div class="container">
    <h1 class="text-success">Informações do Produto</h1>
    <form action="/save-produto-venda" method="post">
      <div class="row mb-3">
        <div class="col-md-12">
          <label for="nome_produto" class="form-label">Nome do Produto *</label>
          <input type="text" class="form-control" id="nome_produto" name="nome_produto" required style="width: 90%">
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="tipo_produto" class="form-label">Tipo do Produto</label>        
          <input type="text" class="form-control" id="tipo_produto" name="tipo_pdroduto" required style="width: 90%">
        </div>
        <div class="col-md-4">
          <label for="validade_ambiente" class="form-label">Validade em Temp. Ambiente</label>
          <input type="number" class="form-control" id="validade_ambiente" name="validade_ambiente" style="width: 98%">
        </div>
        <div class="col-md-4">
          <label for="validade_refrigerado" class="form-label">Validade Refrigerado</label>
          <div class="input-group" style="width: 97%">
            <input type="number" class="form-control" id="validade_refrigerado" name="validade_refrigerado">
            <span class="input-group-text">dias</span>
          </div>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="validade_congelado" class="form-label">Validade Congelado</label>
          <div class="input-group" style="width: 97%">
            <input type="number" class="form-control" id="validade_congelado" name="validade_congelado">
            <span class="input-group-text">dias</span>
          </div>
        </div>
        <div class="col-md-4">
          <label for="rendimento_cru" class="form-label">Rendimento cru</label>
          <div class="input-group" style="width: 97%">
            <span class="input-group-text">G</span>
            <input type="number" class="form-control" id="rendimento_cru" name="rendimento_cru">
          </div>
        </div>
        <div class="col-md-4">
          <label for="rendimento_cozido" class="form-label">Rendimento cozido</label>
          <div class="input-group" style="width: 97%">
            <span class="input-group-text">G</span>
            <input type="number" class="form-control" id="rendimento_cozido" name="rendimento_cozido">
          </div>
        </div>
      </div>


      <div class="form-row mt-4">
        <div class="form-group col-md-4">
          <label for="tempo-preparo">Tempo de Preparo</label>
          <div class="input-group">
            <input type="text" class="form-control" id="tempo-preparo" name="tempo-preparo"
              data-inputmask="'mask': '9{1,3}'">
            <div class="input-group-append">
              <span class="input-group-text">minutos</span>
            </div>
          </div>
        </div>
    
        <div class="form-group col-md-4">
          <label for="tempo-forno">Tempo de Forno/Fogo</label>
          <div class="input-group">
            <input type="text" class="form-control" id="tempo-forno" name="tempo-forno"
              data-inputmask="'mask': '9{1,3}'">
            <div class="input-group-append">
              <span class="input-group-text">minutos</span>
            </div>
          </div>
        </div>
    
        <div class="form-group col-md-4">
          <label for="tempo-total">Tempo Total</label>
          <div class="input-group">
            <input type="text" class="form-control" id="tempo-total" name="tempo-total"
              data-inputmask="'mask': '9{1,3}'">
            <div class="input-group-append">
              <span class="input-group-text">minutos</span>
            </div>
          </div>
        </div>
      </div>
    
      <div class="form-row mt-4">
        <div class="form-group col-md-4">
          <label for="refrigeracao">Temperatura de Refrigeração</label>
          <div class="input-group">
            <input type="text" class="form-control" id="refrigeracao" name="refrigeracao"
              data-inputmask="'mask': '9{1,3}'">
            <div class="input-group-append">
              <span class="input-group-text">C</span>
            </div>
          </div>
        </div>
    
        <div class="form-group col-md-4">
          <label for="congelamento">Temperatura de Congelamento</label>
          <div class="input-group">
            <input type="text" class="form-control" id="congelamento" name="congelamento"
              data-inputmask="'mask': '-9{1,3}'">
            <div class="input-group-append">
              <span class="input-group-text">C</span>
            </div>
          </div>
        </div>
        <div class="form-group col-md-4">
          <label for="congelamento">Quantidade de produto:</label>
          <div class="input-group">
            <input type="text" class="form-quantidade" id="quantidade" name="quantidade"
              data-inputmask="'mask': '9{1,3}'">
            <div class="input-group-append">
              <span class="input-group-text">C</span>
            </div>
          </div>
        </div>
        </div>


        
          <div class="form-group">
            <label for="frequencia">Frequência de preparo:</label>
            <input type="text" class="form-control" id="frequencia" name="frequencia" data-inputmask="'mask': '9{1,}'" value="DIARIO" style="width: 98%;">
          </div>
          <div class="form-group">
            <label for="responsavel">Resp. pelo preparo:</label>
            <input type="text" class="form-control" id="responsavel" name="responsavel" data-inputmask="'mask': '9{1,}'" value="YARINNE" style="width: 98%;">
          </div>



          <div class="p-2"> </div>


          <h1 class="text-success">Ingredientes usados</h1>
        
          <div class="p-2"> </div>
          <table class="table">
            <col width="19%">
            <col width="19%">
            <col width="19%">
            <col width="19%">
            <col width="19%">
            <col width="5%">

            <thead>
              <tr>
                <th>Ingredientes</th>
                <th>Preço </th>
                <th>Quantidade de Embalagem</th>
                
                <th>Quantidade Usada</th>
                <th>Custo da Receita</th>
              
                <th></th>
              </tr>
            </thead>
            <tbody id="ingredientes-tbody">
              <% for (let i = 0; i < 4; i++) { %>
              <tr>
                <td>
                  <select class="form-select" name="ingredientes[]" required>
                    <option value="">Selecione um ingrediente</option>
                    <% for (const ingrediente of ingredientes) { %>
                    <option value="<%= ingrediente.id %>"><%= ingrediente.ds_nome %></option>
                    <% } %>
                  </select>
                </td>
                <td>
                  <div class="input-group">
                    <span class="input-group-text">R$</span>
                    <input type="number" class="form-control update-preco" readonly>
                  </div>
                </td>
                <td>
                  <div class="input-group">
                    

                    <input type="number" class="form-control update-quantidade" name="quantidades[]"  readonly>
                    <span class="input-group-text">G/ml</span>
                  </div>
                </td>
             
                <td>
                  <div class="input-group">
                    <input type="number" class="form-control quantidades-usada" name="quantidades_usada[]" required>
                    <span class="input-group-text">G/ml</span>
                  </div>
                </td>
                <td>
                  <div class="input-group">
                    <span class="input-group-text">R$</span>
                    <input type="number" class="form-control update-custo" readonly>
                  </div>
                </td>
                <td>
                  <button type="button" class="btn btn-danger remover-ingrediente"><i class="fas fa-trash-alt"></i></button>
                </td>
              </tr>
              <% } %>
            </tbody>
            <tfoot>
              <tr>
                <td colspan="6">
                  <button type="button" class="btn btn-success adicionar-ingrediente">Adicionar</button>
                </td>
             
              </tr>
              <TR>
                <td colspan="5">
                  <h3 > TOTAL :   <b id="custo_de_ingredientes">R$ 0.00 </b>   </h3>   
                </td>
              </TR>
            </tfoot>
          </table>
          
          
          
          <div class="p-4"> </div>
           


          <button type="submit" class="btn btn-success">Salvar</button>
          <a href="/ingredientes" class="btn btn-danger">Cancelar</a>
        </form>

</div>
<div class="p-4"> </div>
<div class="p-4"> </div>
<div class="p-4"> </div>
<div class="p-4"> </div>
<%- include('../layouts/main_footer.ejs'); %>

<script>

 
  $(document).ready(function() {
 
 
    const ingredientes = <%- ingredientesText %>;
    $('select[name="ingredientes[]"]').change(function() {
      const id = $(this).val();
      const tr = $(this).closest('tr');
      const preco = ingredientes.find(ingrediente => ingrediente.id == id);
      tr.find('.update-preco').val(preco.preco);
      tr.find('.update-quantidade').val(preco.quantidade);
      update_custo(tr);
    });

    $('input[name="quantidades_usada[]"], input[name="quantidades[]"]').keyup(function() {
      const tr = $(this).closest('tr');
      update_custo(tr);
    });

    function update_custo(tr) {
      const id = tr.find('select[name="ingredientes[]"]').val();
      const preco = tr.find('.update-preco').val();
      const quantidades = tr.find('input[name="quantidades[]"]').val();
      const quantidades_usada = tr.find('.quantidades-usada').val();
      if (preco && quantidades && quantidades_usada) {
        const custo = (preco / quantidades) * quantidades_usada;
        tr.find('.update-custo').val(custo.toFixed(2));
        atualizarCustoTotal()
      }
    } 





     // adiciona um novo ingrediente à tabela
     $(".adicionar-ingrediente").on("click", function() {
              // clona a última linha da tabela
              const $lastRow = $("#ingredientes-tbody tr:last");
              const $newRow = $lastRow.clone();
              // limpa os valores dos inputs clonados
              $newRow.find("input, select").val("");
              // adiciona a nova linha à tabela
              $lastRow.after($newRow);
            });
          
            // remove um ingrediente da tabela
            $("#ingredientes-tbody").on("click", ".remover-ingrediente", function() {
              $(this).closest("tr").remove();
              atualizarCustoTotal()
            });


            function atualizarCustoTotal() {
  let soma = 0;
  let inputs = document.querySelectorAll('.update-custo');
  for (let i = 0; i < inputs.length; i++) {
    if (inputs[i].value && !isNaN(inputs[i].value)) {
      soma += parseFloat(inputs[i].value);
    }
  }
  let totalGeral = document.querySelector('#total_geral');
  totalGeral.textContent = "" + soma.toFixed(2);

  
  document.querySelector('#custo_de_ingredientes').textContent = "" + soma.toFixed(2);


}



  });  




</script>

